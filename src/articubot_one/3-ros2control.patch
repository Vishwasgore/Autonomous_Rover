From 0085689ee023baac604268cdf7a9ce85a0ed7bae Mon Sep 17 00:00:00 2001
From: Josh Newans <josh.newans@gmail.com>
Date: Sat, 17 Sep 2022 12:01:59 +1000
Subject: [PATCH] Add initial ros2_control code

---
 config/my_controllers.yaml     | 68 ++++++++++++++++++++++++++++++++++
 description/robot.urdf.xacro   |  3 +-
 description/ros2_control.xacro | 33 +++++++++++++++++
 launch/launch_sim.launch.py    | 15 ++++++++
 4 files changed, 118 insertions(+), 1 deletion(-)
 create mode 100644 config/my_controllers.yaml
 create mode 100644 description/ros2_control.xacro

diff --git a/config/my_controllers.yaml b/config/my_controllers.yaml
new file mode 100644
index 00000000..026ec647
--- /dev/null
+++ b/config/my_controllers.yaml
@@ -0,0 +1,68 @@
+controller_manager:
+  ros__parameters:
+    update_rate: 30
+    use_sim_time: true
+
+    diff_cont:
+      type: diff_drive_controller/DiffDriveController
+
+    joint_broad:
+      type: joint_state_broadcaster/JointStateBroadcaster
+
+diff_cont:
+  ros__parameters:
+
+    publish_rate: 50.0
+
+    base_frame_id: base_link
+
+    left_wheel_names: ['left_wheel_joint']
+    right_wheel_names: ['right_wheel_joint']
+    wheel_separation: 0.35
+    wheel_radius: 0.05
+
+    use_stamped_vel: false
+
+    # open_loop: false    
+
+    # wheels_per_side: x
+    # wheel_separation_multiplier: x
+    # left_wheel_radius_multiplier: x
+    # right_wheel_radius_multiplier: x
+
+    # odom_frame_id: x
+    # pose_covariance_diagonal: x
+    # twist_covariance_diagonal: x
+    # open_loop: x
+    # enable_odom_tf: x
+
+    # cmd_vel_timeout: x
+    # publish_limited_velocity: x
+    # velocity_rolling_window_size: x
+    
+
+    # linear.x.has_velocity_limits: false
+    # linear.x.has_acceleration_limits: false
+    # linear.x.has_jerk_limits: false
+    # linear.x.max_velocity: NAN
+    # linear.x.min_velocity: NAN
+    # linear.x.max_acceleration: NAN
+    # linear.x.min_acceleration: NAN
+    # linear.x.max_jerk: NAN
+    # linear.x.min_jerk: NAN
+
+    # angular.z.has_velocity_limits: false
+    # angular.z.has_acceleration_limits: false
+    # angular.z.has_jerk_limits: false
+    # angular.z.max_velocity: NAN
+    # angular.z.min_velocity: NAN
+    # angular.z.max_acceleration: NAN
+    # angular.z.min_acceleration: NAN
+    # angular.z.max_jerk: NAN
+    # angular.z.min_jerk: NAN
+
+
+
+
+# joint_broad:
+#   ros__parameters:
\ No newline at end of file
diff --git a/description/robot.urdf.xacro b/description/robot.urdf.xacro
index 1c5a5b42..69f7696a 100644
--- a/description/robot.urdf.xacro
+++ b/description/robot.urdf.xacro
@@ -3,7 +3,8 @@
 
     <xacro:include filename="robot_core.xacro" />
 
-    <xacro:include filename="gazebo_control.xacro" />
+    <!-- <xacro:include filename="gazebo_control.xacro" /> -->
+    <xacro:include filename="ros2_control.xacro" />
     <xacro:include filename="lidar.xacro" />
     <xacro:include filename="camera.xacro" />
     <!-- <xacro:include filename="depth_camera.xacro" /> -->
diff --git a/description/ros2_control.xacro b/description/ros2_control.xacro
new file mode 100644
index 00000000..60dc6ca9
--- /dev/null
+++ b/description/ros2_control.xacro
@@ -0,0 +1,33 @@
+<?xml version="1.0"?>
+<robot xmlns:xacro="http://www.ros.org/wiki/xacro">
+
+
+    <ros2_control name="GazeboSystem" type="system">
+        <hardware>
+            <plugin>gazebo_ros2_control/GazeboSystem</plugin>
+        </hardware>
+        <joint name="left_wheel_joint">
+            <command_interface name="velocity">
+                <param name="min">-10</param>
+                <param name="max">10</param>
+            </command_interface>
+            <state_interface name="velocity"/>
+            <state_interface name="position"/>
+        </joint>
+        <joint name="right_wheel_joint">
+            <command_interface name="velocity">
+                <param name="min">-10</param>
+                <param name="max">10</param>
+            </command_interface>
+            <state_interface name="velocity"/>
+            <state_interface name="position"/>
+        </joint>
+    </ros2_control>
+
+    <gazebo>
+        <plugin name="gazebo_ros2_control" filename="libgazebo_ros2_control.so">
+            <parameters>$(find articubot_one)/config/my_controllers.yaml</parameters>
+        </plugin>
+    </gazebo>
+
+</robot>
\ No newline at end of file
diff --git a/launch/launch_sim.launch.py b/launch/launch_sim.launch.py
index a68fdf9a..c2506e4a 100755
--- a/launch/launch_sim.launch.py
+++ b/launch/launch_sim.launch.py
@@ -38,10 +38,25 @@ def generate_launch_description():
                         output='screen')
 
 
+    diff_drive_spawner = Node(
+        package="controller_manager",
+        executable="spawner.py",
+        arguments=["diff_cont"],
+    )
+
+    joint_broad_spawner = Node(
+        package="controller_manager",
+        executable="spawner.py",
+        arguments=["joint_broad"],
+    )
+
+
 
     # Launch them all!
     return LaunchDescription([
         rsp,
         gazebo,
         spawn_entity,
+        diff_drive_spawner,
+        joint_broad_spawner
     ])
